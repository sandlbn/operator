apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

nameSuffix: -tdx

resources:
- ../base

images:
- name: quay.io/confidential-containers/reqs-payload
  newTag: latest
- name: quay.io/kata-containers/kata-deploy
  newName: quay.io/kata-containers/kata-deploy-ci
  newTag: kata-containers-latest

patches:
- patch: |-
    - op: replace
      path: /spec/config/runtimeClasses
      value:
      - name: "kata-qemu-tdx"
        snapshotter: ""
        pulltype: ""
      - name: "kata-qemu"
        snapshotter: ""
        pulltype: ""
    - op: add
      path: /spec/config/debug
      value: true
    - op: add
      path: /spec/config/environmentVariables
      value:
        - name: "INSTALL_OFFICIAL_CONTAINERD"
          value: "false"
        - name: "INSTALL_COCO_CONTAINERD"
          value: "false"
        - name: "INSTALL_VFIO_GPU_CONTAINERD"
          value: "false"
        - name: "INSTALL_NYDUS_SNAPSHOTTER"
          value: "false"
        - name: "CONFIGURE_CC"
          value: "yes"
        - name: "DEBUG"
          value: "true"
    - op: replace
      path: /spec/config/installCmd
      value: 
      - /bin/bash
      - -c
      - |
        set -e
        echo "Installing Kata for RKE2/K3s with TDX support..."
        
        # Detect containerd config location
        if [ -d "/var/lib/rancher/rke2" ]; then
          CONFIG_PATH="/var/lib/rancher/rke2/agent/etc/containerd"
          CONFIG_FILE="$CONFIG_PATH/config.toml.tmpl"
          echo "Detected RKE2"
        elif [ -d "/var/lib/rancher/k3s" ]; then
          CONFIG_PATH="/var/lib/rancher/k3s/agent/etc/containerd"
          CONFIG_FILE="$CONFIG_PATH/config.toml.tmpl"
          echo "Detected K3s"
        else
          CONFIG_PATH="/etc/containerd"
          CONFIG_FILE="$CONFIG_PATH/config.toml"
          echo "Using standard containerd path"
        fi
        
        # Install kata binaries
        echo "Installing kata binaries..."
        cp -a /opt/kata-artifacts/opt/kata /opt/
        chmod +x /opt/kata/bin/*
        
        # Create symlinks
        mkdir -p /usr/local/bin
        ln -sf /opt/kata/bin/kata-runtime /usr/local/bin/kata-runtime
        ln -sf /opt/kata/bin/containerd-shim-kata-v2 /usr/local/bin/containerd-shim-kata-v2
        ln -sf /opt/kata/bin/kata-collect-data.sh /usr/local/bin/kata-collect-data.sh
        
        # Create kata configuration directory
        mkdir -p /etc/kata-containers/
        ln -sf /opt/kata/share/defaults/kata-containers/configuration.toml /etc/kata-containers/configuration.toml
        
        # Create TDX-specific configuration
        echo "Creating TDX configuration..."
        TDX_CONFIG="/opt/kata/share/defaults/kata-containers/configuration-qemu-tdx.toml"
        if [ ! -f "$TDX_CONFIG" ]; then
          cp /opt/kata/share/defaults/kata-containers/configuration-qemu.toml "$TDX_CONFIG"
          
          # Add TDX-specific settings
          cat >> "$TDX_CONFIG" << 'EOFTDX'

        # TDX Configuration
        [hypervisor.qemu]
        confidential_guest = true
        tdx = true
        kernel_params = " tdx_guest=on"

        [hypervisor.qemu.tdx]
        # TDX specific settings will be here

        EOFTDX
        fi
        
        # Update containerd config
        echo "Updating containerd configuration..."
        mkdir -p "$CONFIG_PATH"
        
        # Check if kata is already configured
        if [ -f "$CONFIG_FILE" ] && ! grep -q "io.containerd.kata.v2" "$CONFIG_FILE"; then
          echo "Adding kata runtime configuration to containerd..."
          cat >> "$CONFIG_FILE" << 'EOFCONFIG'

        # Kata Containers Runtime
        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.kata]
          runtime_type = "io.containerd.kata.v2"
          privileged_without_host_devices = true
          pod_annotations = ["io.katacontainers.*"]
          container_annotations = ["io.katacontainers.*"]
          
        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.kata.options]
          ConfigPath = "/opt/kata/share/defaults/kata-containers/configuration.toml"

        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.kata-qemu]
          runtime_type = "io.containerd.kata.v2"
          privileged_without_host_devices = true
          pod_annotations = ["io.katacontainers.*"]
          container_annotations = ["io.katacontainers.*"]
          
        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.kata-qemu.options]
          ConfigPath = "/opt/kata/share/defaults/kata-containers/configuration-qemu.toml"

        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.kata-qemu-tdx]
          runtime_type = "io.containerd.kata.v2"
          privileged_without_host_devices = true
          pod_annotations = ["io.katacontainers.*"]
          container_annotations = ["io.katacontainers.*"]
          
        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.kata-qemu-tdx.options]
          ConfigPath = "/opt/kata/share/defaults/kata-containers/configuration-qemu-tdx.toml"
        EOFCONFIG
        fi
        
        echo "Kata installation completed!"
        echo "Please restart your RKE2/K3s service:"
        echo "  For RKE2: sudo systemctl restart rke2-agent"
        echo "  For K3s: sudo systemctl restart k3s-agent"
        
        # Create a marker file
        touch /opt/kata/.installed
    - op: replace
      path: /spec/config/uninstallCmd
      value:
      - /bin/bash
      - -c
      - |
        echo "Uninstalling Kata..."
        rm -rf /opt/kata
        rm -f /usr/local/bin/kata-runtime
        rm -f /usr/local/bin/containerd-shim-kata-v2
        rm -f /usr/local/bin/kata-collect-data.sh
        rm -rf /etc/kata-containers
        echo "Kata uninstalled"
    - op: replace
      path: /spec/config/installerVolumes
      value:
        - hostPath:
            path: /opt/kata-artifacts/
            type: DirectoryOrCreate
          name: kata-artifacts
        - hostPath:
            path: /var/lib/rancher/rke2/agent/etc/containerd/
            type: DirectoryOrCreate
          name: rke2-containerd-conf
        - hostPath:
            path: /var/lib/rancher/k3s/agent/etc/containerd/
            type: DirectoryOrCreate
          name: k3s-containerd-conf
        - hostPath:
            path: /etc/containerd/
            type: DirectoryOrCreate
          name: containerd-conf
        - hostPath:
            path: /usr/local/bin/
            type: DirectoryOrCreate
          name: local-bin
        - hostPath:
            path: /opt/kata/
            type: DirectoryOrCreate
          name: kata-install
    - op: replace
      path: /spec/config/installerVolumeMounts
      value:
        - mountPath: /opt/kata-artifacts/
          name: kata-artifacts
          readOnly: true
        - mountPath: /var/lib/rancher/rke2/agent/etc/containerd/
          name: rke2-containerd-conf
        - mountPath: /var/lib/rancher/k3s/agent/etc/containerd/
          name: k3s-containerd-conf
        - mountPath: /etc/containerd/
          name: containerd-conf
        - mountPath: /usr/local/bin/
          name: local-bin
        - mountPath: /opt/kata/
          name: kata-install
    - op: add
      path: /spec/ccNodeSelector
      value:
        matchLabels:
          # Deploy only on TDX-capable nodes if labeled
          # Remove or modify this if you want to deploy on all nodes
          node-role.kubernetes.io/worker: "true"
  target:
    kind: CcRuntime